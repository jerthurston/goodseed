// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==============================================================================
// Auth Models - NextAuth.js v5 with Prisma Adapter
// ==============================================================================

enum UserRole {
  ADMIN
  USER
}

model User {
  id                    String                 @id @default(cuid())
  name                  String?
  email                 String?                @unique
  email_verified        DateTime?
  image                 String?
  password              String?
  role                  UserRole               @default(USER)
  isTwoFactorEnabled    Boolean                @default(false)
  bio                   String?
  acquisitionDate       DateTime?              @default(now())
  acquisitionSource     String?
  lastActiveAt          DateTime?
  lifetimeValue         Float?                 @default(0)
  // subscriptionType       SubscriptionType?       @default(FREE)
  totalSpent            Float?                 @default(0)
  // userSegment            UserSegment?            @default(REGULAR)
  chatSettings          Json?
  lastChatAt            DateTime?
  preferredLanguage     String                 @default("en")
  totalChatSessions     Int                    @default(0)
  twoFactorConfirmation TwoFactorConfirmation?
  session               Session[]
  account               Account[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorConfirmation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

// ==============================================================================
// Application Models - GoodSeed MVP
// ==============================================================================

// Seed Types: Loại hạt giống có các loại chính: 
/**
 * Regular Seeds: Hạt giống thông thường,
 * Feminized Seeds: Hạt giống nữ hóa,
 * Autoflower Seeds: Hạt giống tự động ra hoa,
 * Photoperiod Seeds:Hạt giống quang kỳ
 */
enum SeedType {
  REGULAR
  FEMINIZED
  AUTOFLOWER
  PHOTOPERIOD
}

// Cannabis Types Loại cây cần sa, thường được gọi là "strain" (giống/chủng) :
/**
 * SATIVA: Cây cao, gầy, lá mỏng, thường mang lại hiệu ứng kích thích tinh thần, tăng năng lượng và sáng tạo.
 * INDICA :Cây thường thấp, rậm rạp, lá rộng, có xu hướng cho cảm giác thư giãn toàn thân, an thần.,
 * HYBRID: Kết hợp các đặc điểm của cả Indica và Sativa, mang lại nhiều tác dụng đa dạng. Đây là loại phổ biến nhất hiện nay.,
 * RUDERALIS:Một loại phụ sinh trưởng ở khí hậu khắc nghiệt, đặc điểm chính là khả năng tự động ra hoa dựa trên độ tuổi chứ không phải chu kỳ ánh sáng.
 */
enum CannabisType {
  SATIVA
  INDICA
  HYBRID
}

// Stock Status
enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
  LIMITED
}

// Seller (Cửa hàng/Website - Affiliate Partner)
// Đại diện cho các site bán hạt giống (e.g., Seed Supreme, ILGM, Herbies)
// GoodSeed làm affiliate marketing để chuyển hướng traffic đến website của họ
model Seller {
  id                  String    @id @default(cuid())
  name                String    @unique // "Seed Supreme", "ILGM"
  url                 String // Homepage URL
  scrapingSourceUrl   String // URL of products listing page to scrape (e.g., https://vancouverseedbank.ca/shop/jsf/epro-archive-products/)
  affiliateTag        String? // Affiliate tag để tạo commission URL
  isActive            Boolean   @default(true) // Kill switch để ẩn seller
  autoScrapeInterval  Int?      @default(6) // Auto scrape interval in hours
  lastScraped         DateTime?
  status              String? // success/error
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  seedCategories SeedProductCategory[]
  scrapeLogs     ScrapeLog[]
  scrapeJobs     ScrapeJob[]

  @@index([isActive])
  @@index([lastScraped])
}

// SeedProductCategory là danh mục product :Sativa, Indica, Hybrid. 
//Có nhiều loại lai tạo như: sativa dominant hybrid, indica dominant hybrid, balance hybrid. Những loại này sẽ standardize name về Hybrid
model SeedProductCategory {
  id          String  @id @default(cuid())
  sellerId    String
  name        String
  // cannabisType CannabisType? // SATIVA, INDICA, HYBRID
  slug        String
  description String? // Mô tả ngắn (nếu có)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller       Seller        @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  seedProducts SeedProduct[] // 1 Category → N Products
  scrapeJobs   ScrapeJob[]   // Jobs targeting this category

  @@index([id])
}

// SeedProduct (Sản phẩm hạt giống cụ thể)
// Đại diện cho product card từ category page
// VD: "Blue Dream Feminized", "Acapulco Gold Feminized"
model SeedProduct {
  id         String @id @default(cuid())
  categoryId String

  // Basic Info (từ category page)
  name        String // "Blue Dream Feminized"
  url         String // URL trang chi tiết sản phẩm
  slug        String // "blue-dream-feminized"
  description String? // Mô tả ngắn (nếu có)

  // Stock
  stockStatus StockStatus @default(IN_STOCK)

  // Cannabis Classification
  // cannabisType CannabisType? // SATIVA, INDICA, HYBRID, RUDERALIS
  seedType     SeedType? // REGULAR, FEMINIZED, AUTOFLOWER, PHOTOPERIOD
  cannabisType CannabisType? // "Mostly Indica", "Hybrid", etc.

  // Cannabinoids
  thcMin  Float?
  thcMax  Float?
  thcText String? // Raw text: "Very High (over 20%)"
  cbdMin  Float?
  cbdMax  Float?
  cbdText String? // Raw text: "Low (0-1%)"

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  category      SeedProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productImages SeedProductImage[]
  pricings      Pricing[]

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([seedType])
  @@index([cannabisType])
  @@index([thcMin, thcMax])
  @@index([cbdMin, cbdMax])
  @@index([stockStatus])
}

model Pricing {
  id            String @id @default(cuid())
  seedProductId String

  totalPrice   Float
  packSize     Int   @default(5)
  pricePerSeed Float // Calculated: totalPrice / packSize

  // Relations
  seedProduct SeedProduct @relation(fields: [seedProductId], references: [id], onDelete: Cascade)

  @@index([pricePerSeed])
}

// Image (Hình ảnh sản phẩm)
model Image {
  id        String   @id @default(cuid())
  url       String   @unique
  alt       String?
  width     Int? //Có thể xóa vì không cần thiết
  height    Int? //Có thể xóa vì không cần thiết
  createdAt DateTime @default(now())

  seedProductImages SeedProductImage[]

  @@index([url])
}

// SeedProductImage (Join table giữa SeedProduct và Image)
model SeedProductImage {
  seedProductId String
  imageId       String
  order         Int      @default(0)
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())

  seedProduct SeedProduct @relation(fields: [seedProductId], references: [id], onDelete: Cascade)
  image       Image       @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@id([seedProductId, imageId])
  @@index([seedProductId])
  @@index([imageId])
  @@index([isPrimary])
}

// ScrapeLog (Lịch sử scraping cho admin dashboard)
model ScrapeLog {
  id            String   @id @default(cuid())
  sellerId      String
  timestamp     DateTime @default(now())
  status        String // success/error
  productsFound Int      @default(0)
  errors        Json? // Lưu chi tiết lỗi nếu có
  duration      Int? // Thời gian chạy (ms)

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([timestamp])
  @@index([status])
}

// ScrapeJobStatus - Job execution status
enum ScrapeJobStatus {
  PENDING     // Job created, waiting to start
  IN_PROGRESS // Currently scraping
  COMPLETED   // Successfully finished
  FAILED      // Error occurred
  CANCELLED   // Manually stopped
}

// ScrapeJob - Track scraping job progress and status
model ScrapeJob {
  id       String          @id @default(cuid())
  sellerId String
  jobId    String          @unique // External job ID for API (e.g., "scrape_1234567890")
  status   ScrapeJobStatus @default(PENDING)

  // Job Configuration
  mode             String  // "batch", "auto", "test"
  targetCategoryId String? // Which SeedProductCategory to save products into
  startPage        Int?
  endPage          Int?
  maxPages         Int?

  // Progress Tracking
  currentPage     Int?
  totalPages      Int?
  productsScraped Int      @default(0)
  productsSaved   Int      @default(0)
  productsUpdated Int      @default(0)
  errors          Int      @default(0)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // milliseconds

  // Error Details
  errorMessage String?
  errorDetails Json?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller         Seller               @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  targetCategory SeedProductCategory? @relation(fields: [targetCategoryId], references: [id], onDelete: SetNull)

  @@index([sellerId])
  @@index([status])
  @@index([jobId])
  @@index([createdAt])
  @@index([targetCategoryId])
}

// Update Seller model to include scrapeJobs relation
// (Add this line to Seller model's relations section)
