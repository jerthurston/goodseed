// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  USER
  BANNED
}

model User {
  id                     String                  @id @default(cuid())
  name                   String?
  email                  String                  @unique
  emailVerified          DateTime?
  image                  String?
  password               String?
  role                   UserRole                @default(USER)
  isTwoFactorEnabled     Boolean                 @default(false)
  bio                    String?
  acquisitionDate        DateTime?               @default(now())
  acquisitionSource      String?
  lastActiveAt           DateTime?
  lifetimeValue          Float?                  @default(0)
  totalSpent             Float?                  @default(0)
  chatSettings           Json?
  lastChatAt             DateTime?
  preferredLanguage      String                  @default("en")
  totalChatSessions      Int                     @default(0)
  //Relations
  twoFactorConfirmation  TwoFactorConfirmation?
  session                Session[]
  account                Account[]
  notificationPreference NotificationPreference?
  wishlist               Wishlist[]
  wishlistFolder         WishlistFolder[]
  // userSegment            UserSegment?            @default(REGULAR)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

// Verification Tokens giao cho nextauth quản lý. Đổi dùng id và email thành identifier để khớp với type prisma adapter
model VerificationToken {
  // id      String   @id @default(cuid())
  // email   String
  identifier String
  token      String   @unique
  expires    DateTime
  // @@map("verification_tokens")

  @@unique([identifier, token])
}

model TwoFactorConfirmation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

// Rate Limiting for Magic Link Authentication
// Prevents abuse and spam by tracking email verification requests
model MagicLinkRateLimit {
  id            String    @id @default(cuid())
  email         String
  ipAddress     String? // Optional: Track by IP for extra security
  attemptCount  Int       @default(1)
  lastAttempt   DateTime  @default(now())
  cooldownUntil DateTime? // NULL = no cooldown, DateTime = blocked until this time

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // @@map("magic_link_rate_limits")

  @@unique([email])
  @@index([email, cooldownUntil]) // Fast lookup for rate limit check
  @@index([createdAt]) // Cleanup old records
}

// Tùy chỉnh notification cho user
model NotificationPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  receiveSpecialOffers Boolean  @default(false) // giữ lại vì ở scoper 
  receivePriceAlerts   Boolean  @default(false)
  receiveBackInStock   Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  //Relations
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==============================================================================
// Application Models - GoodSeed MVP
// ==============================================================================

// Seed Types: Loại hạt giống có các loại chính: 
/**
 * Regular Seeds: Hạt giống thông thường,
 * Feminized Seeds: Hạt giống nữ hóa,
 * Autoflower Seeds: Hạt giống tự động ra hoa,
 * Photoperiod Seeds:Hạt giống quang kỳ
 */
enum SeedType {
  REGULAR
  FEMINIZED
  AUTOFLOWER
  PHOTOPERIOD
}

// Cannabis Types Loại cây cần sa, thường được gọi là "strain" (giống/chủng) :
/**
 * SATIVA: Cây cao, gầy, lá mỏng, thường mang lại hiệu ứng kích thích tinh thần, tăng năng lượng và sáng tạo.
 * INDICA :Cây thường thấp, rậm rạp, lá rộng, có xu hướng cho cảm giác thư giãn toàn thân, an thần.,
 * HYBRID: Kết hợp các đặc điểm của cả Indica và Sativa, mang lại nhiều tác dụng đa dạng. Đây là loại phổ biến nhất hiện nay.,
 * RUDERALIS:Một loại phụ sinh trưởng ở khí hậu khắc nghiệt, đặc điểm chính là khả năng tự động ra hoa dựa trên độ tuổi chứ không phải chu kỳ ánh sáng.
 */
enum CannabisType {
  SATIVA
  INDICA
  HYBRID
}

// Stock Status
enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
  LIMITED
}

// Seller (Cửa hàng/Website - Affiliate Partner)
// Đại diện cho các site bán hạt giống (e.g., Seed Supreme, ILGM, Herbies)
// GoodSeed làm affiliate marketing để chuyển hướng traffic đến website của họ
model Seller {
  id                 String  @id @default(cuid())
  name               String  @unique // "Seed Supreme", "ILGM"
  url                String // Homepage URL Seller
  affiliateTag       String? // Affiliate tag để tạo commission URL
  isActive           Boolean @default(true) // Kill switch để ẩn cách products của seller ở trang seed
  autoScrapeInterval Int?    @default(6) // Auto scrape interval in hours

  lastScraped DateTime? //TODO: có thể để scrapeLog quản lý luôn
  status      String? // success/error - TODO: có thể để scrapeLog quản lý luôn

  // Scraper Configuration (Simple approach) - Build tính năng Crud seller trong tương lai nếu yêu cầu
  // productCardHtml     String? // Raw HTML của 1 product card (admin copy/paste)
  // jsonLd              String? // Raw JSON-LD data (nếu có)
  // paginationPattern   String? // Pattern phân trang: "?pagenum={page}"
  // maxPages            Int?    @default(10)

  // Auto-computed selectors (hệ thống tự tính)
  // computedSelectors   Json?   // Selectors được hệ thống phân tích tự động

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  scrapingSources ScrapingSource[]
  seedCategories  SeedProductCategory[]
  seedProducts    SeedProduct[] // Direct relation to all products
  scrapeLogs      ScrapeLog[]
  scrapeJobs      ScrapeJob[]

  @@index([isActive])
  @@index([lastScraped])
}

model ScrapingSource {
  id                 String @id @default(cuid())
  sellerId           String // Removed @unique to allow multiple sources per seller
  scrapingSourceUrl  String @unique // https://vancouverseedbank.ca/shop ; https://vancouverseedbank.ca/product-category/new-strain/
  scrapingSourceName String //e.g. "vancouverseedbank,herbies..."
  maxPage            Int

  //Relations
  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([sellerId, scrapingSourceUrl]) // Prevent duplicate URL per seller
  @@index([id, sellerId])
}

// SeedProductCategory là danh mục product :Sativa, Indica, Hybrid. 
//Có nhiều loại lai tạo như: sativa dominant hybrid, indica dominant hybrid, balance hybrid. Những loại này sẽ standardize name về Hybrid
model SeedProductCategory {
  id          String  @id @default(cuid())
  sellerId    String
  name        String
  // cannabisType CannabisType? // SATIVA, INDICA, HYBRID
  slug        String
  description String? // Mô tả ngắn (nếu có)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller       Seller        @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  seedProducts SeedProduct[] // 1 Category → N Products
  scrapeJobs   ScrapeJob[] // Jobs targeting this category

  @@index([id])
}

// SeedProduct (Sản phẩm hạt giống cụ thể)
// Đại diện cho product card từ category page
// VD: "Blue Dream Feminized", "Acapulco Gold Feminized"
model SeedProduct {
  id         String @id @default(cuid())
  sellerId   String // Direct relation to Seller for efficient queries
  categoryId String

  // Basic Info (từ category page)
  name        String // "Blue Dream Feminized"
  url         String // URL trang chi tiết sản phẩm
  slug        String // "blue-dream-feminized"
  description String? // Mô tả ngắn (nếu có)

  displayPrice Float? // displayPrice là pricePerSeed ở packsize nhỏ nhất. eg: displayPrice sẽ là 13 khi { packsize: 5 seeds; totalPrice: 65; pricePerSeed: 13 } và  { packsize: 10 seeds; totalPrice: 200; pricePerSeed: 18.33 }

  // Stock
  stockStatus StockStatus @default(IN_STOCK)

  // Cannabis Classification
  // cannabisType CannabisType? // SATIVA, INDICA, HYBRID, RUDERALIS
  seedType     SeedType? // REGULAR, FEMINIZED, AUTOFLOWER, PHOTOPERIOD
  cannabisType CannabisType? // "Mostly Indica", "Hybrid", etc.

  // Cannabinoids
  thcMin  Float?
  thcMax  Float?
  thcText String? // Raw text: "Very High (over 20%)"
  cbdMin  Float?
  cbdMax  Float?
  cbdText String? // Raw text: "Low (0-1%)"

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller        Seller              @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  category      SeedProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productImages SeedProductImage[]
  pricings      Pricing[]
  wishlists     Wishlist[]

  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([sellerId]) // Index for efficient seller-based queries
  @@index([seedType])
  @@index([cannabisType])
  @@index([thcMin, thcMax])
  @@index([cbdMin, cbdMax])
  @@index([stockStatus])
  @@index([displayPrice]) // Index for price sorting
}

model Pricing {
  id            String @id @default(cuid())
  seedProductId String
  totalPrice    Float
  packSize      Int    @default(5)
  pricePerSeed  Float // Calculated: totalPrice / packSize

  //Cần thêm metadata như scrapedAt. Sẽ làm sau.

  // Relations
  seedProduct SeedProduct @relation(fields: [seedProductId], references: [id], onDelete: Cascade)

  @@index([pricePerSeed])
}

// Image (Hình ảnh sản phẩm)
model Image {
  id        String   @id @default(cuid())
  url       String   @unique
  alt       String?
  width     Int? //Có thể xóa vì không cần thiết
  height    Int? //Có thể xóa vì không cần thiết
  createdAt DateTime @default(now())

  seedProductImages SeedProductImage[]

  @@index([url])
}

// SeedProductImage (Join table giữa SeedProduct và Image)
model SeedProductImage {
  seedProductId String
  imageId       String
  order         Int      @default(0)
  isPrimary     Boolean  @default(false)
  createdAt     DateTime @default(now())

  seedProduct SeedProduct @relation(fields: [seedProductId], references: [id], onDelete: Cascade)
  image       Image       @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@id([seedProductId, imageId])
  @@index([seedProductId])
  @@index([imageId])
  @@index([isPrimary])
}

// ScrapeLog (Lịch sử scraping cho admin dashboard)
//TODO: Cần quy hoạch lại bảng scrapeLog thành ScrapeJobLog để liên kết với scrapeJob thay vì seller để enhance hệ thống fix lỗi cho scrape system trong tương lai.
model ScrapeLog {
  id            String   @id @default(cuid())
  sellerId      String
  timestamp     DateTime @default(now())
  status        String // success/error
  productsFound Int      @default(0)
  errors        Json? // Lưu chi tiết lỗi nếu có
  duration      Int? // Thời gian chạy (ms)

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([timestamp])
  @@index([status])
}

// ScrapeJobStatus - Job execution status (sync with Bull Queue states)
enum ScrapeJobStatus {
  CREATED // Job created in database, not yet in queue
  WAITING // Job in Bull queue, waiting to be processed
  DELAYED // Job scheduled for future execution (Bull delayed set)
  ACTIVE // Job currently running (Bull active set)
  COMPLETED // Job finished successfully (Bull completed set)
  FAILED // Job failed with error (Bull failed set)
  CANCELLED // Job manually cancelled or removed
}

// ScrapeJob - Track scraping job progress and status
model ScrapeJob {
  id       String          @id @default(cuid())
  sellerId String
  jobId    String          @unique // External job ID for API (e.g., "scrape_1234567890")
  status   ScrapeJobStatus @default(CREATED)

  // Job Configuration
  mode             String // "batch", "auto", "test"
  targetCategoryId String? // Which SeedProductCategory to save products into
  startPage        Int?
  endPage          Int?
  maxPages         Int?

  // Progress Tracking
  currentPage     Int?
  totalPages      Int?
  productsScraped Int  @default(0)
  productsSaved   Int  @default(0)
  productsUpdated Int  @default(0)
  errors          Int  @default(0)

  // Timing
  startedAt   DateTime?
  completedAt DateTime?
  duration    Int? // milliseconds

  // Error Details
  errorMessage String?
  errorDetails Json?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  seller         Seller               @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  targetCategory SeedProductCategory? @relation(fields: [targetCategoryId], references: [id], onDelete: SetNull)

  @@index([sellerId])
  @@index([status])
  @@index([jobId])
  @@index([createdAt])
  @@index([targetCategoryId])
}

// Wishlist (Danh sách sản phẩm yêu thích của người dùng)
model Wishlist {
  id          String          @id @default(cuid())
  userId      String
  seedId      String
  folderId    String?
  // notifyPrice Boolean @default(false)
  // notifyBackInStock Boolean @default(false)
  // targetPrice Float?
  createdAt   DateTime        @default(now())
  // Relations
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  // 1 wishlist sẽ chứa thông tin của 1 seedProduct
  seedProduct SeedProduct     @relation(fields: [seedId], references: [id], onDelete: Cascade)
  folder      WishlistFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  // folder onDelete:SetNull và folderId:String? để khi xóa folder wishlist được chuyển về uncategoried

  @@unique([userId, seedId])
}

model WishlistFolder {
  id        String     @id @default(cuid())
  userId    String
  name      String
  order     Int
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  //Relations
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  wishlist  Wishlist[]

  @@unique([userId, name]) // đảm bảo không có 2 folder trùng tên nhau.
}

// ============================================
// CMS Models - Content Management System
// ============================================

// Homepage Content - Stores all homepage sections
model HomepageContent {
  id        String   @id @default(cuid())
  
  // Hero Section
  heroTitle       String
  heroDescription String   @db.Text
  
  // How It Works Section
  howItWorksTitle       String
  howItWorksDescription String   @db.Text
  howItWorksSteps       Json     // Array of {title, description}
  
  // Features Section
  featuresTitle       String
  featuresDescription String   @db.Text
  features            Json     // Array of {icon: string, title, description}
  
  // CTA Section
  ctaTitle       String
  ctaDescription String   @db.Text
  ctaLabel       String
  ctaHref        String
  
  // Metadata
  isPublished Boolean  @default(true)
  updatedAt   DateTime @updatedAt
  updatedBy   String   // Admin email who updated
  
  @@map("homepage_content")
}

// FAQ Categories - Main categories for FAQ sections
model FaqCategory {
  id    String @id @default(cuid())
  name  String // "General Questions", "Buying & Pricing", etc.
  icon  String // FontAwesome icon name: "faLeaf", "faShoppingCart", etc.
  order Int    @default(0)
  
  isVisible Boolean @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  faqs Faq[]
  
  @@map("faq_categories")
}

// FAQ Items - Individual questions and answers
model Faq {
  id         String      @id @default(cuid())
  question   String
  answer     String      @db.Text
  order      Int         @default(0)
  
  isVisible  Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  
  // Relations
  categoryId String
  category   FaqCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@index([categoryId, order])
  @@map("faqs")
}

// FAQ Page Settings - Global settings for FAQ page
model FaqPageSettings {
  id                    String   @id @default(cuid())
  title                 String   @default("Frequently Asked Questions")
  description           String   @default("Find answers to the most common questions about our services.")
  noAnswerMessage       String   @default("Can't find the answer you're looking for?")
  contactLabel          String   @default("Contact Us")
  contactHref           String   @default("/contact")
  
  isPublished           Boolean  @default(true)
  updatedAt             DateTime @updatedAt
  updatedBy             String   // Admin email who updated
  
  @@map("faq_page_settings")
}
