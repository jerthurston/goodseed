// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==============================================================================
// Auth Models - NextAuth.js v5 with Prisma Adapter
// ==============================================================================

enum UserRole {
  ADMIN
  USER
}

model User {
  id                    String                 @id @default(cuid())
  name                  String?
  email                 String?                @unique
  email_verified        DateTime?
  image                 String?
  password              String?
  role                  UserRole               @default(USER)
  isTwoFactorEnabled    Boolean                @default(false)
  bio                   String?
  acquisitionDate       DateTime?              @default(now())
  acquisitionSource     String?
  lastActiveAt          DateTime?
  lifetimeValue         Float?                 @default(0)
  // subscriptionType       SubscriptionType?       @default(FREE)
  totalSpent            Float?                 @default(0)
  // userSegment            UserSegment?            @default(REGULAR)
  chatSettings          Json?
  lastChatAt            DateTime?
  preferredLanguage     String                 @default("en")
  totalChatSessions     Int                    @default(0)
  twoFactorConfirmation TwoFactorConfirmation?
  session               Session[]
  account               Account[]

  // aiTool                 AITool[]
  // aiToolReview           AIToolReview[]
  // account                Account[]
  // bookmarkFolder         BookmarkFolder[]
  // bookmarkedAiTool       BookmarkedAiTool[]
  // campaign               Campaign[]
  // chatConversations      ChatConversation[]
  // comments               Comment[]
  // commentLikes           CommentLike[]
  // commentReports         CommentReport[]
  // emailEvent             EmailEvent[]
  // emailTemplate          EmailTemplate[]
  // notification           Notification[]
  // notificationPreference NotificationPreference?
  // post                   Post[]
  // postSeries             PostSeries[]
  // reviewLikes            ReviewLike[]
  // reviewReports          ReviewReport[]
  // userActivity           UserActivity[]
  // userCampaign           UserCampaign[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorConfirmation {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TwoFactorToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}


// ==============================================================================
// Application Models - GoodSeed MVP
// ==============================================================================

// Seed Types
enum SeedType {
  REGULAR
  FEMINIZED
  AUTOFLOWER
}

// Cannabis Types
enum CannabisType {
  SATIVA
  INDICA
  HYBRID
}

// Photoperiod Types
enum PhotoperiodType {
  AUTOFLOWER
  PHOTOPERIOD
}

// Stock Status
enum StockStatus {
  IN_STOCK
  OUT_OF_STOCK
  LIMITED
}

// Seller (Nhà bán hạt giống)
model Seller {
  id            String    @id @default(cuid())
  name          String    @unique
  url           String
  affiliateTag  String?   // Affiliate tag để tạo commission URL
  isActive      Boolean   @default(true) // Kill switch
  lastScraped   DateTime?
  status        String?   // success/error
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  seeds         Seed[]
  scrapeLogs    ScrapeLog[]

  @@index([isActive])
  @@index([lastScraped])
}

// Seed (Hạt giống cannabis)
model Seed {
  id              String          @id @default(cuid())
  sellerId        String
  
  // Basic Info
  name            String
  url             String
  slug            String
  
  // Pricing
  totalPrice      Float           // Giá gói
  packSize        Int             // Số lượng hạt trong gói
  pricePerSeed    Float           // Tự động tính: totalPrice / packSize
  
  // Stock
  stockStatus     StockStatus     @default(IN_STOCK)
  
  // Seed Classification
  seedType        SeedType?       // Regular/Feminized/Autoflower
  cannabisType    CannabisType?   // Sativa/Indica/Hybrid
  photoperiodType PhotoperiodType? // Autoflower/Photoperiod
  
  // Cannabinoids (THC/CBD ranges)
  thcMin          Float?
  thcMax          Float?
  cbdMin          Float?
  cbdMax          Float?
  
  // Metadata
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  seller          Seller          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  seedImages      SeedImage[]

  @@unique([sellerId, slug])
  @@index([pricePerSeed])
  @@index([seedType])
  @@index([cannabisType])
  @@index([thcMin, thcMax])
  @@index([cbdMin, cbdMax])
  @@index([stockStatus])
}

// Image (Hình ảnh sản phẩm)
model Image {
  id            String         @id @default(cuid())
  url           String         @unique
  alt           String?
  width         Int?
  height        Int?
  createdAt     DateTime       @default(now())
  
  seedImages    SeedImage[]

  @@index([url])
}

// SeedImage (Join table giữa Seed và Image)
model SeedImage {
  seedId        String
  imageId       String
  order         Int            @default(0)
  isPrimary     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  
  seed          Seed           @relation(fields: [seedId], references: [id], onDelete: Cascade)
  image         Image          @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@id([seedId, imageId])
  @@index([seedId])
  @@index([imageId])
  @@index([isPrimary])
}

// ScrapeLog (Lịch sử scraping cho admin dashboard)
model ScrapeLog {
  id            String    @id @default(cuid())
  sellerId      String
  timestamp     DateTime  @default(now())
  status        String    // success/error
  productsFound Int       @default(0)
  errors        Json?     // Lưu chi tiết lỗi nếu có
  duration      Int?      // Thời gian chạy (ms)
  
  seller        Seller    @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([timestamp])
  @@index([status])
}
